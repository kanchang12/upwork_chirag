<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV Upload and Analysis Tool</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            color: #333;
            margin: 0;
            padding: 0;
        }
        .container {
            width: 80%;
            margin: 20px auto;
            padding: 20px;
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        .upload-section, .chat-section {
            margin-bottom: 20px;
        }
        h2 {
            color: #003366;
        }
        .chat-transcript {
            width: 100%;
            height: 300px;
            border: 1px solid #ccc;
            overflow-y: scroll;
            padding: 10px;
            background-color: #e6e6e6;
            margin-bottom: 10px;
        }
        .query-input {
            width: calc(100% - 22px);
            padding: 10px;
            border: 1px solid #ccc;
            margin-bottom: 10px;
        }
        .submit-button, .download-button {
            background-color: #003366;
            color: #fff;
            padding: 10px 20px;
            border: none;
            cursor: pointer;
            margin-right: 10px;
        }
        .submit-button:hover, .download-button:hover {
            background-color: #0055a5;
        }
        .result-table {
    border-collapse: collapse;
    width: 100%;
    margin-bottom: 10px;
    table-layout: fixed; /* Ensure fixed table layout */
}

.result-table th, .result-table td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: left;
    word-wrap: break-word; /* Enable word wrap */
    max-width: 150px; /* Set a max width for table cells */
    overflow-wrap: break-word; /* Ensure long words break properly */
}

.result-table th {
    background-color: #f2f2f2; /* Background color for header cells */
}




        .analysis-section {
            display: none;
            margin-top: 20px;
        }
        .analysis-form {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .column-select {
            margin-right: 10px;
        }
        .chat-message.user-message {
            background-color: #d1e7dd;
            padding: 5px;
            margin: 5px;
            border-radius: 5px;
        }
        .chat-message.ai-message {
            background-color: #f8d7da;
            padding: 5px;
            margin: 5px;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="upload-section">
            <h2>Upload CSV File</h2>
            <form id="upload-form" enctype="multipart/form-data">
                <input type="file" name="document" accept=".csv" required>
                <button type="submit" class="submit-button">Upload</button>
                <span id="file-name"></span>
            </form>
        </div>
        <div class="chat-section">
            <h2>Chat Transcript</h2>
            <div class="chat-transcript" id="chat-transcript"></div>
            <form id="chat-form">
                <input type="text" id="query-input" class="query-input" name="message" placeholder="Type your query here..." required>
                <button type="submit" class="submit-button">Submit</button>
            </form>
            <div class="download-buttons">
                <button id="download-csv" class="download-button" style="display: none;">Download as CSV</button>
                <button id="download-xlsx" class="download-button" style="display: none;">Download as XLSX</button>
            </div>
        </div>

        <!-- Analysis Section -->
        <div class="analysis-section" id="analysis-section">
            <h2>Analysis Setup</h2>
            <div id="column-selection">
                <div class="analysis-form">
                    <select id="column-1" class="column-select"></select>
                    <select id="column-2" class="column-select"></select>
                    <select id="column-3" class="column-select"></select>
                    <select id="column-4" class="column-select"></select>
                    <select id="column-5" class="column-select"></select>
                    <input type="number" id="weight" step="0.01" min="0" max="1" placeholder="Enter weight (0 to 1)">
                </div>
                <button id="analyze-button" class="submit-button">Analyze</button>
            </div>
            <div class="download-buttons">
                <button id="download-analyzed" class="download-button" style="display: none;">Download Analyzed Data</button>
            </div>
        </div>
    </div>

    <script>
        let csvData = null;
        document.getElementById('upload-form').addEventListener('submit', function(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    csvData = data; // Assuming the response contains the CSV data as JSON
                    alert(data.message);
                }
            })
            .catch(error => console.error('Error:', error));
        });

        function populateColumnDropdowns(columns) {
            const dropdowns = document.querySelectorAll('.column-select');
            dropdowns.forEach(dropdown => {
                dropdown.innerHTML = '';
                columns.forEach(column => {
                    const option = document.createElement('option');
                    option.value = column;
                    option.textContent = column;
                    dropdown.appendChild(option);
                });
            });
        }
        function showDownloadButtons() {
    document.getElementById('download-csv').style.display = 'inline-block';
    document.getElementById('download-xlsx').style.display = 'inline-block';
}
        document.getElementById('analyze-button').addEventListener('click', function() {
            const selectedColumns = [];
            const dropdowns = document.querySelectorAll('.column-select');
            dropdowns.forEach(dropdown => {
                if (dropdown.value) {
                    selectedColumns.push(dropdown.value);
                }
            });

            const weight = parseFloat(document.getElementById('weight').value);
            if (isNaN(weight) || weight <= 0 || weight > 1) {
                alert('Please enter a valid weight (0 to 1)');
                return;
            }

            const analyzedData = analyzeData(selectedColumns, weight);
            displayAnalysisResults(analyzedData);
            document.getElementById('download-analyzed').style.display = 'inline-block';
        });

        function analyzeData(selectedColumns, weight) {
            const analyzedData = csvData.map(row => {
                const calculatedValue = selectedColumns.reduce((acc, column) => {
                    const value = parseFloat(row[column]);
                    return acc + (isNaN(value) ? 0 : value) * weight;
                }, 0);
                return { ...row, AnalyzedValue: calculatedValue };
            });

            analyzedData.sort((a, b) => b.AnalyzedValue - a.AnalyzedValue);
            return analyzedData;
        }

        function displayAnalysisResults(data) {
            const resultsTable = document.createElement('table');
            resultsTable.innerHTML = `<tr><th>Rank</th><th>Country</th><th>Analyzed Value</th></tr>`;
            data.forEach((row, index) => {
                const tableRow = resultsTable.insertRow();
                tableRow.innerHTML = `<td>${index + 1}</td><td>${row['Country']}</td><td>${row['AnalyzedValue']}</td>`;
            });

            const analysisSection = document.querySelector('.analysis-section');
            analysisSection.appendChild(resultsTable);
        }

        document.getElementById('download-analyzed').addEventListener('click', function() {
            if (!csvData) {
                alert('No data to download');
                return;
            }

            const selectedColumns = document.querySelectorAll('.column-select');
            const headers = Array.from(selectedColumns).map(select => select.value);
            const analyzedData = analyzeData(headers, parseFloat(document.getElementById('weight').value));

            const csvContent = headers.join(',') + '\n' +
                               analyzedData.map(row => headers.map(header => row[header]).join(',')).join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', 'analyzed_data.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        });

document.getElementById('download-csv').addEventListener('click', function() {
    if (!csvData) {
        alert('No data to download');
        return;
    }

    const headers = Object.keys(csvData[0]);
    let csvContent = headers.join(',') + '\n';

    csvData.forEach(row => {
        const values = headers.map(header => {
            const cell = row[header] + '';
            return cell.replace(/"/g, '""');
        });
        csvContent += values.join(',') + '\n';
    });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', 'result.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        });

        document.getElementById('download-xlsx').addEventListener('click', function() {
            if (!csvData) {
                alert('No data to download');
                return;
            }

            const worksheet = XLSX.utils.json_to_sheet(csvData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Results");
            
            XLSX.writeFile(workbook, 'result.xlsx');
        });
        document.getElementById('chat-form').addEventListener('submit', function(event) {
    event.preventDefault();
    const message = document.getElementById('query-input').value.trim();
    const chatTranscript = document.getElementById('chat-transcript');

    // Append user message
    const userMessage = document.createElement('div');
    userMessage.className = 'chat-message user-message';
    userMessage.textContent = `User: ${message}`;
    chatTranscript.appendChild(userMessage);

    // Fetch response for non-greeting messages
    fetch('/chat', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ message: message })
    })
    .then(response => response.json())
    .then(data => {
        const aiMessage = document.createElement('div');
        aiMessage.className = 'chat-message ai-message';

        // Check if the data is a large string or a small string
        if (isLargeString(data)) {
            const table = createTableFromString(data);
            aiMessage.appendChild(table);
        } else {
            aiMessage.textContent = `AI: ${data}`;
        }

        chatTranscript.appendChild(aiMessage);
        document.getElementById('query-input').value = '';
        chatTranscript.scrollTop = chatTranscript.scrollHeight;
    })
    .catch(error => {
        console.error('Error:', error);
        const errorMessage = document.createElement('div');
        errorMessage.textContent = 'AI: An error occurred while processing your request.';
        chatTranscript.appendChild(errorMessage);
    });
});

function isLargeString(str) {
    // Define a threshold for the string length to be considered large
    const threshold = 100; // Adjust this value as needed

    // Check if the string length exceeds the threshold
    return str.length > threshold;
}

function createTableFromString(dataString) {
  // Trim whitespace from the input string
  const trimmedString = dataString.trim();

  // Check if the input is empty
  if (!trimmedString) {
    return null; // Handle empty input gracefully (optional)
  }

  // Split the data string into rows based on newline characters
  const rows = trimmedString.split('\n');

  const table = document.createElement('table');
  table.className = 'result-table';

  // Create header row
  const headerRow = document.createElement('tr');
  const headers = rows[0].split(/\s+/); // Split the first row into headers based on spaces
  headers.forEach(headerText => {
    const th = document.createElement('th');
    th.textContent = headerText;
    headerRow.appendChild(th);
  });
  table.appendChild(headerRow);

  // Create data rows
  const dataRows = [];
  for (let i = 1; i < rows.length; i++) {
    const rowData = rows[i].split(/\s+/); // Split each row into cells based on spaces
    const countryName = handleMultiWordCountries(rowData.slice(1).join(' '));
    const patientIncidence = parseFloat(rowData[2].replace(/,/g, ''));
    const recruitmentRate = parseFloat(rowData[3]);
    const noCompetitorTrials = parseFloat(rowData[4]);

    const score =
      0.5 * patientIncidence +
      0.25 * recruitmentRate +
      0.25 * noCompetitorTrials;

    dataRows.push({
      country: countryName,
      patientIncidence,
      recruitmentRate,
      noCompetitorTrials,
      score
    });
  }

  // Sort data rows based on the calculated score
  dataRows.sort((a, b) => b.score - a.score);

  // Create data rows in the sorted order
  dataRows.forEach(row => {
    const dataRow = document.createElement('tr');

    headers.forEach((headerText, index) => {
      const td = document.createElement('td');
      switch (headerText.trim()) {
        case 'Country':
          td.textContent = row.country || '';
          break;
        case 'Patient Incidence':
          td.textContent = row.patientIncidence || '';
          break;
        case 'Roche Recruitment Rate':
          td.textContent = row.recruitmentRate || '';
          break;
        case 'Percentage of sites with no competitor trials':
          td.textContent = row.noCompetitorTrials || '';
          break;
        case 'Score':
          td.textContent = row.score || '';
          break;
        default:
          td.textContent = ''; // Handle any other headers
      }
      dataRow.appendChild(td);
    });

    table.appendChild(dataRow);
  });

  return table;
}

function handleMultiWordCountries(countryName) {
  const multiWordCountries = [
    'Republic of Korea',
    'South Africa',
    'United Kingdom',
    'United States',
    'Russian Federation'
  ];

  if (multiWordCountries.includes(countryName)) {
    return countryName;
  }

  return countryName;
}



    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.2/xlsx.full.min.js"></script>
</body>
</html>
