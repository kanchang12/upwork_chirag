<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV Upload and Analysis Tool</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            color: #333;
            margin: 0;
            padding: 0;
        }
        .container {
            width: 80%;
            margin: 20px auto;
            padding: 20px;
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        .upload-section, .chat-section {
            margin-bottom: 20px;
        }
        h2 {
            color: #003366;
        }
        .chat-transcript {
            width: 100%;
            height: 300px;
            border: 1px solid #ccc;
            overflow-y: scroll;
            padding: 10px;
            background-color: #e6e6e6;
            margin-bottom: 10px;
        }
        .query-input {
            width: calc(100% - 22px);
            padding: 10px;
            border: 1px solid #ccc;
            margin-bottom: 10px;
        }
        .submit-button, .download-button {
            background-color: #003366;
            color: #fff;
            padding: 10px 20px;
            border: none;
            cursor: pointer;
            margin-right: 10px;
        }
        .submit-button:hover, .download-button:hover {
            background-color: #0055a5;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 10px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .analysis-section {
            display: none;
            margin-top: 20px;
        }
        .analysis-form {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .column-select {
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="upload-section">
            <h2>Upload CSV File</h2>
            <form id="upload-form" enctype="multipart/form-data">
                <input type="file" name="document" accept=".csv" required>
                <button type="submit" class="submit-button">Upload</button>
                <span id="file-name"></span>
            </form>
        </div>
        <div class="chat-section">
            <h2>Chat Transcript</h2>
            <div class="chat-transcript" id="chat-transcript"></div>
            <form id="chat-form">
                <input type="text" id="query-input" class="query-input" name="message" placeholder="Type your query here..." required>
                <button type="submit" class="submit-button">Submit</button>
            </form>
            <div class="download-buttons">
                <button id="download-csv" class="download-button" style="display: none;">Download as CSV</button>
                <button id="download-xlsx" class="download-button" style="display: none;">Download as XLSX</button>
            </div>
        </div>

        <!-- Analysis Section -->
        <div class="analysis-section" id="analysis-section">
            <h2>Analysis Setup</h2>
            <div id="column-selection">
                <div class="analysis-form">
                    <select id="column-1" class="column-select"></select>
                    <select id="column-2" class="column-select"></select>
                    <select id="column-3" class="column-select"></select>
                    <select id="column-4" class="column-select"></select>
                    <select id="column-5" class="column-select"></select>
                    <input type="number" id="weight" step="0.01" min="0" max="1" placeholder="Enter weight (0 to 1)">
                </div>
                <button id="analyze-button" class="submit-button">Analyze</button>
            </div>
            <div class="download-buttons">
                <button id="download-analyzed" class="download-button" style="display: none;">Download Analyzed Data</button>
            </div>
        </div>
    </div>

    <script>
        let csvData = null;
        document.getElementById('upload-form').addEventListener('submit', function(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message || data.error);
            })
            .catch(error => console.error('Error:', error));
        });

        function populateColumnDropdowns(columns) {
            const dropdowns = document.querySelectorAll('.column-select');
            dropdowns.forEach(dropdown => {
                dropdown.innerHTML = '';
                columns.forEach(column => {
                    const option = document.createElement('option');
                    option.value = column;
                    option.textContent = column;
                    dropdown.appendChild(option);
                });
            });
        }

        document.getElementById('analyze-button').addEventListener('click', function() {
            const selectedColumns = [];
            const dropdowns = document.querySelectorAll('.column-select');
            dropdowns.forEach(dropdown => {
                if (dropdown.value) {
                    selectedColumns.push(dropdown.value);
                }
            });

            const weight = parseFloat(document.getElementById('weight').value);
            if (isNaN(weight) || weight <= 0 || weight > 1) {
                alert('Please enter a valid weight (0 to 1)');
                return;
            }

            const analyzedData = analyzeData(selectedColumns, weight);
            displayAnalysisResults(analyzedData);
            document.getElementById('download-analyzed').style.display = 'inline-block';
        });

        function analyzeData(selectedColumns, weight) {
            const analyzedData = csvData.map(row => {
                const calculatedValue = selectedColumns.reduce((acc, column) => {
                    const value = parseFloat(row[column]);
                    return acc + (isNaN(value) ? 0 : value) * weight;
                }, 0);
                return { ...row, AnalyzedValue: calculatedValue };
            });

            analyzedData.sort((a, b) => b.AnalyzedValue - a.AnalyzedValue);
            return analyzedData;
        }

        function displayAnalysisResults(data) {
            const resultsTable = document.createElement('table');
            resultsTable.innerHTML = `<tr><th>Rank</th><th>Country</th><th>Analyzed Value</th></tr>`;
            data.forEach((row, index) => {
                const tableRow = resultsTable.insertRow();
                tableRow.innerHTML = `<td>${index + 1}</td><td>${row['Country']}</td><td>${row['AnalyzedValue']}</td>`;
            });

            const analysisSection = document.querySelector('.analysis-section');
            analysisSection.appendChild(resultsTable);
        }

        document.getElementById('download-analyzed').addEventListener('click', function() {
            if (!csvData) {
                alert('No data to download');
                return;
            }

            const selectedColumns = document.querySelectorAll('.column-select');
            const headers = Array.from(selectedColumns).map(select => select.value);
            const analyzedData = analyzeData(headers, parseFloat(document.getElementById('weight').value));

            const csvContent = headers.join(',') + '\n' +
                               analyzedData.map(row => headers.map(header => row[header]).join(',')).join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', 'analyzed_data.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        });
        document.getElementById('chat-form').addEventListener('submit', function(event) {
            event.preventDefault();
            const message = document.getElementById('query-input').value;
            console.log("Sending message:", message);
            fetch('/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ message: message })
            })
            .then(response => response.json())
            .then(data => {
                console.log("Received data:", data);
                const chatTranscript = document.getElementById('chat-transcript');
                const newMessage = document.createElement('div');
                if (data.error) {
                    newMessage.textContent = `Error: ${data.error}`;
                } else if (data.result) {
                    //newMessage.textContent = `Result: ${data.result}`;
                } else if (Array.isArray(data)) {
                    newMessage.innerHTML = createTable(data);
                } else if (typeof data === 'object' && data !== null) {
                    newMessage.innerHTML = createTable([data]);
                } else {
                    //newMessage.textContent = `Result: ${JSON.stringify(data)}`;
                }
                chatTranscript.appendChild(newMessage);
                chatTranscript.scrollTop = chatTranscript.scrollHeight;
                document.getElementById('query-input').value = '';
            })
            .catch(error => console.error('Error:', error));
        });

        document.getElementById('chat-form').addEventListener('submit', function(event) {
            event.preventDefault();
            const message = document.getElementById('query-input').value;
            const chatTranscript = document.getElementById('chat-transcript');

            const userMessage = document.createElement('div');
            userMessage.className = 'chat-message user-message';
            userMessage.textContent = `You: ${message}`;
            chatTranscript.appendChild(userMessage);

            fetch('/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ message: message })
            })
            .then(response => response.json())
            .then(data => {
                const aiMessage = document.createElement('div');
                aiMessage.className = 'chat-message ai-message';
                
                if (data.error) {
                    aiMessage.textContent = `AI: Error: ${data.error}`;
                } else {
                    //aiMessage.textContent = 'AI: Here\'s the result:';
                    
                    if (Array.isArray(data) && data.length > 0 && typeof data[0] === 'object') {
                        const table = document.createElement('table');
                        const headers = Object.keys(data[0]);
                        
                        const headerRow = table.insertRow();
                        headers.forEach(header => {
                            const th = document.createElement('th');
                            th.textContent = header;
                            headerRow.appendChild(th);
                        });

                        data.forEach(row => {
                            const dataRow = table.insertRow();
                            headers.forEach(header => {
                                const cell = dataRow.insertCell();
                                cell.textContent = row[header];
                            });
                        });

                        aiMessage.appendChild(table);
                        document.getElementById('download-csv').style.display = 'inline-block';
                        document.getElementById('download-xlsx').style.display = 'inline-block';
                    } else {
                        aiMessage.textContent += ` ${JSON.stringify(data, null, 2)}`;
                    }
                }
                chatTranscript.appendChild(aiMessage);
                chatTranscript.scrollTop = chatTranscript.scrollHeight;
                document.getElementById('query-input').value = '';
            })
            .catch(error => console.error('Error:', error));
        });

        document.getElementById('download-csv').addEventListener('click', function() {
            if (!csvData) {
                alert('No data to download');
                return;
            }

            const headers = Object.keys(csvData[0]);
            let csvContent = headers.join(',') + '\n';

            csvData.forEach(row => {
                const values = headers.map(header => {
                    const cell = row[header] + '';
                    return cell.replace(/"/g, '""');
                });
                csvContent += values.join(',') + '\n';
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', 'result.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        });

        document.getElementById('download-xlsx').addEventListener('click', function() {
            if (!csvData) {
                alert('No data to download');
                return;
            }

            const worksheet = XLSX.utils.json_to_sheet(csvData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Results");
            
            XLSX.writeFile(workbook, 'result.xlsx');
        });
    </script>
<script>
    document.getElementById('chat-form').addEventListener('submit', function(event) {
        event.preventDefault();
        const message = document.getElementById('query-input').value.trim().toLowerCase();

        // Handle greetings separately
        if (['hi', 'hello', 'hey'].includes(message)) {
            const aiMessage = document.createElement('div');
            aiMessage.className = 'chat-message ai-message';
            aiMessage.textContent = 'AI: Hi, how may I help you?';
            document.getElementById('chat-transcript').appendChild(aiMessage);
            document.getElementById('query-input').value = '';
            document.getElementById('chat-transcript').scrollTop = document.getElementById('chat-transcript').scrollHeight;
            return; // Exit early without making the fetch call
        }

        // Proceed with fetching the response for non-greeting messages
        const userMessage = document.createElement('div');
        userMessage.className = 'chat-message user-message';
        //userMessage.textContent = `You: ${message}`;
        document.getElementById('chat-transcript').appendChild(userMessage);

        fetch('/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ message: message })
        })
        .then(response => response.json())
        .then(data => {
            const aiMessage = document.createElement('div');
            aiMessage.className = 'chat-message ai-message';

            if (data.error) {
                aiMessage.textContent = `AI: Error: ${data.error}`;
            } else if (data.Result && Array.isArray(data.Result)) {
                //aiMessage.textContent = 'AI: Here\'s the result:';

                const table = document.createElement('table');
                table.classList.add('result-table');

                // Create header row
                const headerRow = document.createElement('tr');
                const headers = ['Rank', 'Country'];
                headers.forEach(headerText => {
                    const th = document.createElement('th');
                    th.textContent = headerText;
                    headerRow.appendChild(th);
                });
                table.appendChild(headerRow);

                // Create data rows
                data.Result.forEach((country, index) => {
                    const row = document.createElement('tr');
                    const rankCell = document.createElement('td');
                    rankCell.textContent = (index + 1).toString();
                    row.appendChild(rankCell);

                    const countryCell = document.createElement('td');
                    countryCell.textContent = country;
                    row.appendChild(countryCell);

                    table.appendChild(row);
                });

                aiMessage.appendChild(table);
                showDownloadButtons();
            } else {
                aiMessage.textContent = `AI: Result: ${JSON.stringify(data)}`;
            }

            document.getElementById('chat-transcript').appendChild(aiMessage);
            document.getElementById('query-input').value = '';
            document.getElementById('chat-transcript').scrollTop = document.getElementById('chat-transcript').scrollHeight;
        })
        .catch(error => {
            console.error('Error:', error);
            const errorMessage = document.createElement('div');
            errorMessage.textContent = 'AI: An error occurred while processing your request.';
            document.getElementById('chat-transcript').appendChild(errorMessage);
        });
    });

    function showDownloadButtons() {
        document.getElementById('download-csv').style.display = 'inline-block';
        document.getElementById('download-xlsx').style.display = 'inline-block';
    }
</script>

    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.2/xlsx.full.min.js"></script>
</body>
</html>
